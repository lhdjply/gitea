{{$canWriteProject := and .CanWriteProjects (or (not .Repository) (not .Repository.IsArchived))}}

<div class="ui container fluid padded projects-view">
	<div class="ui container flex-text-block project-header">
		<h2>{{.Project.Title}}</h2>
		<div class="tw-flex-1"></div>
		<div class="ui secondary menu tw-m-0">
			{{$queryLink := QueryBuild "?" "labels" .SelectLabels "assignee" $.AssigneeID "archived_labels" (Iif $.ShowArchivedLabels "true")}}
			{{template "repo/issue/filter_item_label" dict "Labels" .Labels "QueryLink" $queryLink "SupportArchivedLabel" true}}
			{{template "repo/issue/filter_item_user_assign" dict
				"QueryParamKey" "assignee"
				"QueryLink" $queryLink
				"UserSearchList" $.Assignees
				"SelectedUserId" $.AssigneeID
				"TextFilterTitle" (ctx.Locale.Tr "repo.issues.filter_assignee")
				"TextFilterMatchNone" (ctx.Locale.Tr "repo.issues.filter_assignee_no_assignee")
				"TextFilterMatchAny" (ctx.Locale.Tr "repo.issues.filter_assignee_any_assignee")
			}}
		</div>
		{{if $canWriteProject}}
			<div class="ui compact mini menu">
				<a class="item screen-full">
					{{svg "octicon-screen-full"}}
					{{ctx.Locale.Tr "projects.enter_fullscreen"}}
				</a>
				<a class="item screen-normal tw-hidden">
					{{svg "octicon-screen-normal"}}
					{{ctx.Locale.Tr "projects.exit_fullscreen"}}
				</a>
				<a class="item" href="{{.Link}}/edit?redirect=project">
					{{svg "octicon-pencil"}}
					{{ctx.Locale.Tr "repo.issues.label_edit"}}
				</a>
				{{if .Project.IsClosed}}
					<button class="item btn link-action" data-url="{{.Link}}/open">
						{{svg "octicon-check"}}
						{{ctx.Locale.Tr "repo.projects.open"}}
					</button>
				{{else}}
					<button class="item btn link-action" data-url="{{.Link}}/close">
						{{svg "octicon-skip"}}
						{{ctx.Locale.Tr "repo.projects.close"}}
					</button>
				{{end}}
				<button class="item btn link-action" data-url="{{.Link}}/delete?id={{.Project.ID}}"
								data-modal-confirm-header="{{ctx.Locale.Tr "repo.projects.deletion"}}"
								data-modal-confirm-content="{{ctx.Locale.Tr "repo.projects.deletion_desc"}}"
				>
					{{svg "octicon-trash"}}
					{{ctx.Locale.Tr "repo.issues.label_delete"}}
				</button>
				<button class="item btn show-modal show-project-column-modal-edit" data-modal="#project-column-modal-edit"
								data-modal-header="{{ctx.Locale.Tr "repo.projects.column.new"}}"
								data-modal-project-column-title-label="{{ctx.Locale.Tr "repo.projects.column.new_title"}}"
								data-modal-project-column-button-save="{{ctx.Locale.Tr "repo.projects.column.new_submit"}}"
								data-modal-project-column-id=""
								data-modal-project-column-title-input=""
								data-modal-project-column-color-input=""
				>
					{{svg "octicon-plus"}}
					{{ctx.Locale.Tr "new_project_column"}}
				</button>
			</div>
		{{end}}
	</div>

	<div class="ui container project-description">
		<div class="render-content markup">
			{{$.Project.RenderedContent}}
		</div>
		<div class="divider"></div>
	</div>

	<div id="project-board" class="board {{if $canWriteProject}}sortable{{end}}" data-project-borad-writable="{{$canWriteProject}}" {{if $canWriteProject}}data-url="{{$.Link}}/move"{{end}}>
		{{range .Columns}}
			<div class="project-column" {{if .Color}}style="background: {{.Color}} !important; color: {{ContrastColor .Color}} !important"{{end}} data-id="{{.ID}}" data-sorting="{{.Sorting}}" data-url="{{$.Link}}/{{.ID}}">
				<div class="project-column-header{{if $canWriteProject}} tw-cursor-grab{{end}}">
					<div class="ui circular label project-column-issue-count">
						{{.NumIssues}}
					</div>
					<div class="project-column-title-text flex-text-inline gt-ellipsis" {{if .Default}}data-tooltip-content="{{ctx.Locale.Tr "repo.projects.column.default_column_hint"}}"{{end}}>
						{{if .Default}}{{svg "octicon-star"}} {{end}}{{.Title}}
					</div>
					{{if $canWriteProject}}
						<div class="ui dropdown tw-p-1">
							{{svg "octicon-kebab-horizontal"}}
							<div class="menu">
								<a class="item button show-modal show-project-column-modal-edit" data-modal="#project-column-modal-edit"
									data-modal-header="{{ctx.Locale.Tr "repo.projects.column.edit"}}"
									data-modal-project-column-title-label="{{ctx.Locale.Tr "repo.projects.column.edit_title"}}"
									data-modal-project-column-button-save="{{ctx.Locale.Tr "repo.projects.column.edit"}}"
									data-modal-project-column-id="{{.ID}}"
									data-modal-project-column-title-input="{{.Title}}"
									data-modal-project-column-color-input="{{.Color}}"
								>
									{{svg "octicon-pencil"}} {{ctx.Locale.Tr "repo.projects.column.edit"}}
								</a>
								<a class="item button show-modal show-add-issue-modal" data-modal="#add-issue-modal"
									data-modal-header="{{ctx.Locale.Tr "repo.projects.column.add_issue"}}"
									data-modal-column-id="{{.ID}}"
								>
									{{svg "octicon-issue-opened"}} {{ctx.Locale.Tr "repo.projects.column.add_issue"}}
								</a>
								<a class="item button show-modal show-add-pull-modal" data-modal="#add-pull-modal"
									data-modal-header="{{ctx.Locale.Tr "repo.projects.column.add_pull"}}"
									data-modal-column-id="{{.ID}}"
								>
									{{svg "octicon-git-pull-request"}} {{ctx.Locale.Tr "repo.projects.column.add_pull"}}
								</a>
								{{if $.Project.IsOrganizationProject}}
									<a class="item button show-modal show-bind-repo-modal" data-modal="#bind-repo-modal"
										data-modal-header="{{ctx.Locale.Tr "repo.projects.column.bind_repos"}}"
										data-modal-column-id="{{.ID}}"
									>
										{{svg "octicon-repo"}} {{ctx.Locale.Tr "repo.projects.column.bind_repos"}}
									</a>
								{{end}}
								{{if not .Default}}
									<a class="item button link-action" data-url="{{$.Link}}/{{.ID}}/default"
										data-modal-confirm-header="{{ctx.Locale.Tr "repo.projects.column.set_default"}}"
										data-modal-confirm-content="{{ctx.Locale.Tr "repo.projects.column.set_default_desc"}}"
									>
										{{svg "octicon-star"}} {{ctx.Locale.Tr "repo.projects.column.set_default"}}
									</a>
									<a class="item button link-action" data-url="{{$.Link}}/{{.ID}}" data-link-action-method="DELETE"
										data-modal-confirm-header="{{ctx.Locale.Tr "repo.projects.column.delete"}}"
										data-modal-confirm-content="{{ctx.Locale.Tr "repo.projects.column.deletion_desc"}}"
									>
										{{svg "octicon-trash"}} {{ctx.Locale.Tr "repo.projects.column.delete"}}
									</a>
								{{end}}
							</div>
						</div>
					{{end}}
				</div>
				<div class="divider"{{if .Color}} style="color: {{ContrastColor .Color}} !important"{{end}}></div>
				<div class="ui cards" data-url="{{$.Link}}/{{.ID}}" data-project="{{$.Project.ID}}" data-board="{{.ID}}" id="board_{{.ID}}">
					{{$columnID := .ID}}
					{{range (index $.ColumnCardsMap $columnID)}}
						{{if eq .Type "repo"}}
							<div class="issue-card tw-break-anywhere repo-card {{if $canWriteProject}}tw-cursor-grab{{end}}" data-repo="{{.Repo.ID}}">
								<div class="content tw-w-full">
									<div class="tw-flex tw-items-start tw-gap-[5px]">
										<div class="issue-card-icon">
											<span class="text green">{{svg "octicon-repo" 16}}</span>
										</div>
										<a class="issue-card-title muted issue-title tw-break-anywhere" href="{{.Repo.Link}}" target="_blank">{{.Repo.FullName}}</a>
										{{if $canWriteProject}}
											<a role="button" class="issue-card-unbind muted tw-flex tw-items-center" data-tooltip-content="{{ctx.Locale.Tr "repo.projects.column.unbind"}}" data-card-type="repo" data-id="{{.Repo.ID}}" data-column-id="{{$columnID}}">
												{{svg "octicon-x" 16}}
											</a>
										{{end}}
									</div>
									{{if .Repo.Description}}
										<div class="meta tw-my-1">
											<span class="text light grey">{{.Repo.Description}}</span>
										</div>
									{{end}}
									<div class="meta tw-my-1">
										<span class="text light grey muted-links tw-flex tw-items-center">
											<span class="tw-flex tw-items-center">{{svg "octicon-star" 12 "tw-mr-1"}} {{.Repo.NumStars}}</span>
											<span class="tw-flex tw-items-center tw-ml-2">{{svg "octicon-git-branch" 12 "tw-mr-1"}} {{.Repo.NumForks}}</span>
										</span>
									</div>
								</div>
													</div>
												{{else}}
													<div class="issue-card tw-break-anywhere {{if $canWriteProject}}tw-cursor-grab{{end}}" data-issue="{{.Issue.ID}}">
														{{template "repo/issue/card" (dict "Issue" .Issue "Page" $ "ShowUnbind" $canWriteProject "UnbindColumnID" $columnID)}}
													</div>
												{{end}}
											{{end}}
										</div>
									</div>
								{{end}}	</div>
</div>

{{if $canWriteProject}}
<div class="ui small modal" id="project-column-modal-edit">
	<div class="header">edit</div>
	<div class="content">
		<form class="ui form ignore-dirty" method="post" data-action-base-link="{{$.Link}}">
			<input class="project-column-id" type="hidden" name="id">
			<div class="required field">
				<label class="project-column-title-label" for="project-column-title-input">title</label>
				<input id="project-column-title-input" name="title" required>
			</div>
			<div class="field">
				<label class="project-column-color-label" for="project-column-color-input">color</label>
				<div class="color-picker-combo" data-global-init="initColorPicker">
					<input maxlength="7" placeholder="#c320f6" id="project-column-color-input" name="color">
					{{template "repo/issue/label_precolors"}}
				</div>
			</div>
			<div class="actions">
				<button class="ui cancel button">{{ctx.Locale.Tr "settings.cancel"}}</button>
				<button type="submit" class="ui primary button project-column-button-save">save</button>
			</div>
		</form>
	</div>
</div>

<div class="ui small modal" id="add-issue-modal">
	<div class="header">{{ctx.Locale.Tr "repo.projects.column.add_issue"}}</div>
	<div class="content">
		<form class="ui form ignore-dirty" method="post" action="{{$.Link}}/add-issue">
			{{.CsrfTokenHtml}}
			<input type="hidden" name="column_id" id="add-issue-column-id">
			{{if .Repository}}
				<input type="hidden" name="repo" id="issue-repo" value="{{.Repository.ID}}" data-owner="{{.Repository.OwnerName}}" data-name="{{.Repository.Name}}">
			{{else}}
				<div class="required field">
					<label for="issue-repo">{{ctx.Locale.Tr "repo.issues.new.repo"}}</label>
					<select name="repo" id="issue-repo" required>
						<option value="">{{ctx.Locale.Tr "repo.issues.choose_repo"}}</option>
						{{range .AvailableRepos}}
							<option value="{{.ID}}" data-owner="{{.OwnerName}}" data-name="{{.Name}}">{{.Name}}</option>
						{{end}}
					</select>
				</div>
			{{end}}
			<div class="required field">
				<label for="issue-number">{{ctx.Locale.Tr "repo.issues.number"}}</label>
				<select name="issue_number" id="issue-number" required {{if .Repository}}{{else}}disabled{{end}}>
					<option value="">{{ctx.Locale.Tr "repo.issues.choose_issue"}}</option>
				</select>
			</div>
			<div class="actions">
				<button class="ui cancel button">{{ctx.Locale.Tr "settings.cancel"}}</button>
				<button type="submit" class="ui primary button">{{ctx.Locale.Tr "repo.projects.column.add_issue"}}</button>
			</div>
		</form>
	</div>
</div>

<div class="ui small modal" id="add-pull-modal">
	<div class="header">{{ctx.Locale.Tr "repo.projects.column.add_pull"}}</div>
	<div class="content">
		<form class="ui form ignore-dirty" method="post" action="{{$.Link}}/add-pull">
			{{.CsrfTokenHtml}}
			<input type="hidden" name="column_id" id="add-pull-column-id">
			{{if .Repository}}
				<input type="hidden" name="repo" id="pull-repo" value="{{.Repository.ID}}" data-owner="{{.Repository.OwnerName}}" data-name="{{.Repository.Name}}">
			{{else}}
				<div class="required field">
					<label for="pull-repo">{{ctx.Locale.Tr "repo.pulls.new.repo"}}</label>
					<select name="repo" id="pull-repo" required>
						<option value="">{{ctx.Locale.Tr "repo.pulls.choose_repo"}}</option>
						{{range .AvailableRepos}}
							<option value="{{.ID}}" data-owner="{{.OwnerName}}" data-name="{{.Name}}">{{.Name}}</option>
						{{end}}
					</select>
				</div>
			{{end}}
			<div class="required field">
				<label for="pull-number">{{ctx.Locale.Tr "repo.pulls.number"}}</label>
				<select name="pull_number" id="pull-number" required {{if .Repository}}{{else}}disabled{{end}}>
					<option value="">{{ctx.Locale.Tr "repo.pulls.choose_pull"}}</option>
				</select>
			</div>
			<div class="actions">
				<button class="ui cancel button">{{ctx.Locale.Tr "settings.cancel"}}</button>
				<button type="submit" class="ui primary button">{{ctx.Locale.Tr "repo.projects.column.add_pull"}}</button>
			</div>
		</form>
	</div>
</div>

<div class="ui small modal" id="bind-repo-modal">
	<div class="header">{{ctx.Locale.Tr "repo.projects.column.bind_repos"}}</div>
	<div class="content">
		<form class="ui form ignore-dirty" method="post" action="{{$.Link}}/bind-repos">
			{{.CsrfTokenHtml}}
			<input type="hidden" name="column_id" id="bind-repo-column-id">
			<div class="field">
				<label for="bind-repos">{{ctx.Locale.Tr "repo.projects.column.select_repos"}}</label>
				<select name="repo_ids" id="bind-repos">
					<option value="">{{ctx.Locale.Tr "repo.projects.column.choose_repos"}}</option>
					{{range .AvailableRepos}}
						<option value="{{.ID}}">{{.Name}}</option>
					{{end}}
				</select>
			</div>
			<div class="actions">
				<button class="ui cancel button">{{ctx.Locale.Tr "settings.cancel"}}</button>
				<button type="submit" class="ui primary button">{{ctx.Locale.Tr "repo.projects.column.bind_repos"}}</button>
			</div>
		</form>
	</div>
</div>

<script>
// Handle opening the add issue modal and set the column_id
document.querySelectorAll('.show-add-issue-modal').forEach(button => {
	button.addEventListener('click', function(e) {
		const columnId = this.getAttribute('data-modal-column-id');
		document.getElementById('add-issue-column-id').value = columnId;
		
		// For repository projects, auto-load issues
		const issueRepoSelect = document.getElementById('issue-repo');
		if (issueRepoSelect && issueRepoSelect.type === 'hidden') {
			const changeEvent = new Event('change');
			issueRepoSelect.dispatchEvent(changeEvent);
		}
	});
});

// Handle opening the add pull modal and set the column_id
document.querySelectorAll('.show-add-pull-modal').forEach(button => {
	button.addEventListener('click', function(e) {
		const columnId = this.getAttribute('data-modal-column-id');
		document.getElementById('add-pull-column-id').value = columnId;
		
		// For repository projects, auto-load pull requests
		const pullRepoSelect = document.getElementById('pull-repo');
		if (pullRepoSelect && pullRepoSelect.type === 'hidden') {
			const changeEvent = new Event('change');
			pullRepoSelect.dispatchEvent(changeEvent);
		}
	});
});

// Load issues when repository is selected
document.getElementById('issue-repo').addEventListener('change', async function() {
	const issueSelect = document.getElementById('issue-number');
	
	if (!this.value) {
		issueSelect.disabled = true;
		issueSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "repo.issues.choose_issue"}}</option>';
		return;
	}
	
	let owner, name;
	if (this.type === 'hidden') {
		// For repository projects, get owner and name from data attributes or current page
		owner = this.getAttribute('data-owner') || '{{if .Repository}}{{.Repository.OwnerName}}{{end}}';
		name = this.getAttribute('data-name') || '{{if .Repository}}{{.Repository.Name}}{{end}}';
	} else {
		// For organization projects, get from selected option
		const selectedOption = this.options[this.selectedIndex];
		owner = selectedOption.getAttribute('data-owner');
		name = selectedOption.getAttribute('data-name');
	}
	
	issueSelect.disabled = true;
	issueSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "loading"}}</option>';
	
	try {
		const response = await fetch(`/api/v1/repos/${owner}/${name}/issues?state=open&type=issues`);
		const issues = await response.json();
		
		issueSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "repo.issues.choose_issue"}}</option>';
		issues.forEach(issue => {
			const option = document.createElement('option');
			option.value = issue.number;
			option.textContent = `#${issue.number} - ${issue.title}`;
			issueSelect.appendChild(option);
		});
		issueSelect.disabled = false;
	} catch (error) {
		console.error('Failed to load issues:', error);
		issueSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "error.occurred"}}</option>';
	}
});

// Handle opening the bind repo modal and set the column_id
document.querySelectorAll('.show-bind-repo-modal').forEach(button => {
	button.addEventListener('click', async function(e) {
		const columnId = this.getAttribute('data-modal-column-id');
		document.getElementById('bind-repo-column-id').value = columnId;
		
		// Load currently bound repos for this column
		const select = document.getElementById('bind-repos');
		if (select) {
			try {
				const response = await fetch(`{{$.Link}}/${columnId}/repos`);
				const boundRepos = await response.json();
				
				// Set selected option (only first one for single select)
				if (boundRepos.length > 0) {
					select.value = boundRepos[0].toString();
				} else {
					select.value = '';
				}
			} catch (error) {
				console.error('Failed to load bound repos:', error);
			}
		}
	});
});

// Load pull requests when repository is selected
document.getElementById('pull-repo').addEventListener('change', async function() {
	const pullSelect = document.getElementById('pull-number');
	
	if (!this.value) {
		pullSelect.disabled = true;
		pullSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "repo.pulls.choose_pull"}}</option>';
		return;
	}
	
	let owner, name;
	if (this.type === 'hidden') {
		// For repository projects, get owner and name from data attributes or current page
		owner = this.getAttribute('data-owner') || '{{if .Repository}}{{.Repository.OwnerName}}{{end}}';
		name = this.getAttribute('data-name') || '{{if .Repository}}{{.Repository.Name}}{{end}}';
	} else {
		// For organization projects, get from selected option
		const selectedOption = this.options[this.selectedIndex];
		owner = selectedOption.getAttribute('data-owner');
		name = selectedOption.getAttribute('data-name');
	}
	
	pullSelect.disabled = true;
	pullSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "loading"}}</option>';
	
	try {
		const response = await fetch(`/api/v1/repos/${owner}/${name}/pulls?state=open`);
		const pulls = await response.json();
		
		pullSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "repo.pulls.choose_pull"}}</option>';
		pulls.forEach(pull => {
			const option = document.createElement('option');
			option.value = pull.number;
			option.textContent = `#${pull.number} - ${pull.title}`;
			pullSelect.appendChild(option);
		});
		pullSelect.disabled = false;
	} catch (error) {
		console.error('Failed to load pull requests:', error);
		pullSelect.innerHTML = '<option value="">{{ctx.Locale.Tr "error.occurred"}}</option>';
	}
});

// Handle unbind button click for all card types
document.querySelectorAll('.issue-card-unbind').forEach(button => {
	button.addEventListener('click', async function(e) {
		e.preventDefault();
		e.stopPropagation();
		
		const cardType = this.getAttribute('data-card-type');
		const id = this.getAttribute('data-id');
		const columnId = this.getAttribute('data-column-id');
		
		if (!confirm('{{ctx.Locale.Tr "repo.projects.column.unbind_confirm"}}')) {
			return;
		}
		
		// Get CSRF token
		const csrfToken = window.config?.csrfToken || '';
		
		try {
			let response;
			if (cardType === 'repo') {
				// Unbind repository
				response = await fetch(`{{$.Link}}/${columnId}/unbind-repo`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'X-Csrf-Token': csrfToken,
					},
					body: `repo_id=${id}`
				});
			} else {
				// Unbind issue/PR
				response = await fetch(`{{$.Link}}/${columnId}/unbind-issue`, {
					method: 'POST',
					headers: {
						'Content-Type': 'application/x-www-form-urlencoded',
						'X-Csrf-Token': csrfToken,
					},
					body: `issue_id=${id}`
				});
			}
			
			if (response.ok) {
				// Remove the card from DOM
				const card = this.closest('.issue-card');
				card.remove();
				
				// Update the card count
				const column = document.querySelector(`.project-column[data-id="${columnId}"]`);
				const countLabel = column.querySelector('.project-column-issue-count');
				const currentCount = parseInt(countLabel.textContent);
				countLabel.textContent = currentCount - 1;
			} else {
				alert('{{ctx.Locale.Tr "error.occurred"}}');
			}
		} catch (error) {
			console.error('Failed to unbind card:', error);
			alert('{{ctx.Locale.Tr "error.occurred"}}');
		}
	});
});
</script>
{{end}}
